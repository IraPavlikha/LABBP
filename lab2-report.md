# Лабораторна робота №2: Аутентифікація, авторизація та розширений функціонал
## Проєкт: Онлайн-платформа для аукціонної торгівлі антикваріатом

---

## Мета роботи
Реалізація системи аутентифікації (JWT), розмежування прав доступу (RBAC), впровадження файлового сервісу, пошуку, пагінації та документування API.

---

## Технологічний стек
* **Backend:** Node.js, NestJS (або Express.js за контекстом лістингів)
* **Database:** MongoDB + Mongoose ODM
* **Security:** JWT (JSON Web Tokens), bcrypt (хешування паролів)
* **Media:** Cloudinary API + Multer
* **Frontend:** React.js + Tailwind CSS
* **Real-time:** Socket.io
* **Documentation:** Swagger / Open API

---

## 1. Опис предметної області
Платформа призначена для проведення онлайн-аукціонів антикварних виробів. Система забезпечує повний життєвий цикл лота: від створення та модерації до проведення торгів у реальному часі та визначення переможця.

### Ключові сутності:
* **User:** Користувачі з ролями `User` та `Admin`.
* **Auction Item:** Предмети антикваріату з категоріями та медіа-файлами.
* **Bid:** Ставки користувачів із валідацією мінімального кроку.

---

## 2. Реалізований функціонал 

### Рівень 1 & 2 (Виконано)
* ✅ **Аутентифікація:** Реєстрація та вхід з використанням JWT. Паролі зберігаються у хешованому вигляді через `bcrypt`.
* ✅ **Авторизація:** Впроваджено `AuthMiddleware` для захисту приватних маршрутів та перевірки ролей.
* ✅ **Файловий сервіс:** Інтеграція з Cloudinary для збереження фотографій лотів.
* ✅ **Пошук та фільтрація:** Можливість пошуку лотів за назвою, категорією та статусом завершення.
* ✅ **Пагінація та сортування:** Реалізовано вибірку активних аукціонів із сортуванням за часом створення.

---

## 3. Архітектура системи та База даних

### ER-діаграма
Система базується на чотирьох основних колекціях MongoDB: `Users`, `Products` (Items), `Bids` та `Sessions`.


<img width="634" height="634" alt="image" src="https://github.com/user-attachments/assets/87258d5e-81ba-417f-b331-f0755a43b48f" />

> **Рисунок 2.1** — Схема взаємозв'язків у базі даних.

---

## 4. Реалізація API та Безпека

### Аутентифікація та JWT
Для захисту ендпоінтів використовується Bearer Token схема. При логіні сервер генерує `accessToken`, який клієнт додає до заголовків `Authorization`.

### Лістинг 2.1  Контролер створення аукціону (createAuction)
```
export const createAuction = async (req, res) => {
    try {
        await connectDB();
        const { itemName, startingPrice, itemDescription, itemCategory, itemStartDate, itemEndDate } = req.body;
        let imageUrl = '';
        if (req.file) {
            try {
                imageUrl = await uploadImage(req.file);
            } catch (error) {
                return res.status(500).json({ message: 'Error uploading image to Cloudinary', error: error.message });
            }
        }
        const start = itemStartDate ? new Date(itemStartDate) : new Date();
        const end = new Date(itemEndDate);
        if (end <= start) {
            return res.status(400).json({ message: 'Auction end date must be after start date' });
        }
        const newAuction = new Product({
            itemName,
            startingPrice,
            currentPrice: startingPrice,
            itemDescription,
            itemCategory,
            itemPhoto: imageUrl,
            itemStartDate: start,
            itemEndDate: end,
            seller: req.user.id,
        });
        await newAuction.save();
        res.status(201).json({ message: 'Auction created successfully', newAuction });
    } catch (error) {
        res.status(500).json({ message: 'Error creating auction', error: error.message });
    }
};
```
Даний фрагмент демонструє логіку валідації введених даних, зокрема перевірку дати завершення аукціону та обробку завантаження зображення, що дозволяє забезпечити коректність збереження інформації у базі даних.
Метод GET для отримання інформації про всі активні аукціони реалізовано наступним чином:
### Лістинг 2.2 Отримання списку активних аукціонів (showAuction)
```
export const showAuction = async (req, res) => {
    try {
        await connectDB();
        const auction = await Product.find({ itemEndDate: { $gt: new Date() } })
            .populate("seller", "name")
            .select("itemName itemDescription currentPrice bids itemEndDate itemCategory itemPhoto seller")
            .sort({ createdAt: -1 });
        const formatted = auction.map(auction => ({
            _id: auction._id,
            itemName: auction.itemName,
            itemDescription: auction.itemDescription,
            currentPrice: auction.currentPrice,
            bidsCount: auction.bids.length,
            timeLeft: Math.max(0, new Date(auction.itemEndDate) - new Date()),
            itemCategory: auction.itemCategory,
            sellerName: auction.seller.name,
            itemPhoto: auction.itemPhoto,
        }));
        res.status(200).json(formatted);
    } catch (error) {
        return res.status(500).json({ message: 'Error fetching auctions', error: error.message });
    }
};
```
Цей код ілюструє механізм отримання даних із бази та їх форматування для фронтенду, зокрема підрахунок кількості ставок та часу до завершення аукціону. Також застосовується метод populate для отримання імені продавця із колекції користувачів.

### Документація API
До проєкту підключено Swagger, що дозволяє тестувати ендпоінти в інтерактивному режимі.

GET /api/auction — перегляд усіх лотів.

POST /api/auction/:id/bid — подання ставки (доступно лише авторизованим).

### 5. Користувацький інтерфейс

<img width="667" height="482" alt="image" src="https://github.com/user-attachments/assets/cbda1650-a4a8-4b83-8d25-d8be3c19f2fe" />

> **Рисунок 2.3 — Візуалізація Landing Page

Процес торгів
Користувачі бачать таймер зворотного відліку та динамічне оновлення ціни завдяки Socket.io.
Головна сторінка платформи (Landing Page) призначена для користувачів, які ще не зареєстровані або не ввійшли до системи. Вона містить презентаційний блок із коротким описом платформи, її перевагами, лозунгом та закликом до дії. Кнопки для реєстрації та входу розташовані у верхній частині сторінки та завжди доступні користувачу. Додатково на головній сторінці відображаються популярні або останні лоти, що дозволяє потенційним користувачам ознайомитися з асортиментом та зацікавитися участю в аукціоні. Дизайн цієї сторінки передбачає гармонійне поєднання текстових та візуальних елементів, які підкреслюють престиж і унікальність антикварних предметів.


<img width="679" height="491" alt="image" src="https://github.com/user-attachments/assets/f6af6284-afe9-42a8-811a-dc0cde6313f3" />

> **Рисунок 2.4 Сторінка логіну та реєстрації

Сторінка логіну та реєстрації забезпечує доступ до функцій платформи зареєстрованим користувачам. Форми для входу та створення нового облікового запису мають чітко позначені поля для введення електронної пошти, пароля та іншої необхідної інформації. У разі некоректного введення даних система відображає повідомлення про помилки, що дозволяє уникнути плутанини та підвищує зручність користування. Важливим елементом є наявність кнопок для переходу між сторінками логіну та реєстрації, що забезпечує швидку навігацію та зменшує кількість дій, необхідних для початку роботи на платформі

### 6. Висновки
В ході лабораторної роботи було розроблено захищений Backend для аукціонної платформи. Впроваджено механізми JWT-аутентифікації, обробки медіа-даних та реалізовано логіку торгів з валідацією бізнес-правил. Код відповідає принципам чистої архітектури та готовий до масштабування.

# Контрольні запитання та відповіді до проєкту "Онлайн-аукціон антикваріату"

## 1. Різниця між аутентифікацією та авторизацією
**Аутентифікація** — перевірка особи користувача (чи він дійсно той, ким себе видає).  
**Авторизація** — перевірка прав користувача (що йому дозволено робити).  

**Приклад у проєкті:**  
- Аутентифікація: користувач входить через email і пароль, система перевіряє правильність даних.  
- Авторизація: лише користувач з роллю `admin` може видаляти лоти або блокувати користувачів.

---

## 2. JWT токен
**JWT (JSON Web Token)** — це безпечний спосіб передачі інформації про користувача у вигляді токена.  

Складається з трьох частин:  
1. Header — містить тип токена та алгоритм підпису.  
2. Payload — дані користувача і додаткова інформація (наприклад, id, роль).  
3. Signature — підпис, який гарантує цілісність токена.  

**Чому популярний:**  
- Можна передавати дані без звернення до бази.  
- Легко інтегрувати в REST API.  
- Підтримує статeless аутентифікацію.

---

## 3. bcrypt
**bcrypt** — алгоритм хешування паролів для безпечного зберігання.  

- Хешує пароль з використанням **salt** — випадкових даних, що додаються до пароля для ускладнення злому через rainbow tables.  
- Безпечний, бо навіть при однакових паролях хеші будуть різні.  

---

## 4. Middleware в Express.js
**Middleware** — це функції, що обробляють запити між клієнтом і сервером.  

**У проєкті використано:**  
- `authMiddleware` — перевіряє JWT для доступу до захищених маршрутів.  
- `roleMiddleware` — перевіряє роль користувача для авторизації дій.

---

## 5. RBAC (Role-Based Access Control)
Система **RBAC** визначає доступ користувачів до ресурсів залежно від ролі.  

**У проєкті:**  
- Ролі: `user`, `admin`.  
- `admin` може видаляти лоти та блокувати користувачів.  
- `user` може лише переглядати лоти, створювати свої лоти та робити ставки.

---

## 6. Multer для завантаження файлів
**Multer** — middleware для обробки `multipart/form-data` (завантаження файлів).  

**У проєкті:**  
- Обмеження: максимальний розмір файлу 5 МБ.  
- Валідація: тільки зображення формату JPG, PNG.  
- Інтегровано з Cloudinary для зберігання медіафайлів.

---

## 7. Пагінація
Пагінація дозволяє розбивати великі списки на сторінки.  

**Параметри у проєкті:**  
- `page` — номер сторінки.  
- `limit` — кількість елементів на сторінку.  

**Приклад:**  
```http
GET /api/auction?page=2&limit=10
```
##8. Swagger

Swagger — інструмент для автоматичної документації API.

**Переваги:**

-Можна тестувати endpoints прямо з документації.

-Легко інтегрувати нові маршрути та підтримувати актуальність документації.

-Зручно для командної роботи та зовнішніх інтеграцій.

##9. Основні загрози безпеки вебдодатків

-SQL/NoSQL ін’єкції

-XSS (скрипти у формі)

-CSRF (шкідливі запити від користувача)

-Крадіжка токенів

**Як мінімізовано у проєкті:**

-Використання JWT з підписом.

-Хешування паролів через bcrypt.

-Валідація введених даних.

-Захист маршрутів middleware.

##10. Access токен vs Refresh токен

**Access токен:** короткостроковий, використовується для авторизації запитів.

**Refresh токен:** довгостроковий, використовується для отримання нового access токена без повторного логіну.

**Навіщо два токени:**

Зменшує ризик компрометації (короткий access токен).

Дозволяє користувачу залишатися в системі без повторного входу.
